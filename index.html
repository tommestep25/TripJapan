<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ไปดูหิมะ</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-image: url("https://wallpapercat.com/w/full/3/1/7/119871-3840x2160-desktop-4k-japan-wallpaper-image.jpg");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .trip-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .info-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border-left: 4px solid #3498db;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .itinerary-section,
      .map-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .day-card {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        margin: 20px 0;
        padding: 25px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
      }

      .day-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      .day-card.active {
        border-color: #3498db;
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .day-number {
        background: #2c3e50;
        color: white;
        padding: 10px 15px;
        border-radius: 50px;
        font-weight: bold;
      }

      .day-date {
        color: #666;
        font-size: 0.9em;
      }

      .activities {
        margin-top: 15px;
      }

      .activity {
        background: rgba(255, 255, 255, 0.7);
        padding: 10px 15px;
        margin: 8px 0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .activity-icon {
        font-size: 1.2em;
      }

      #map {
        height: 500px;
        border-radius: 15px;
        border: 3px solid #ddd;
      }

      .budget-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
      }

      .budget-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .budget-card {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
      }

      .price {
        font-size: 1.5em;
        font-weight: bold;
        color: #2c3e50;
      }

      .route-info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #2196f3;
      }

      .special-highlight {
        background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
        text-align: center;
      }

      .warning {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ffeaa7;
        margin: 15px 0;
      }

      .calculator-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 20px;
      }

      .input-section,
      .result-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        border: 2px solid #e9ecef;
      }

      .calculator-grid {
        display: grid;
        gap: 15px;
      }

      .calc-card {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .calc-card label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #2c3e50;
      }

      .calc-card input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        margin: 10px 0;
      }

      .calc-card input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3498db;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .value-display {
        text-align: center;
        font-weight: bold;
        color: #27ae60;
        padding: 5px;
        background: #e8f5e8;
        border-radius: 5px;
      }

      .total-display {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }

      .total-per-person,
      .total-group {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
      }

      .big-number {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
      }

      .budget-status {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        font-weight: bold;
      }

      .status-good {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .breakdown-chart {
        margin-top: 20px;
      }

      .chart-container {
        background: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ddd;
      }

      .chart-bar {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 0.9em;
      }

      .bar {
        height: 20px;
        border-radius: 10px;
        margin-right: 10px;
        transition: all 0.3s ease;
      }

      .flight-bar {
        background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
      }
      .hotel-bar {
        background: linear-gradient(45deg, #4ecdc4, #7fdddc);
      }
      .car-bar {
        background: linear-gradient(45deg, #45b7d1, #6bc7e8);
      }
      .ticket-bar {
        background: linear-gradient(45deg, #96ceb4, #b8e6c1);
      }
      .food-bar {
        background: linear-gradient(45deg, #feca57, #fed57a);
      }
      .shopping-bar {
        background: linear-gradient(45deg, #ff9ff3, #f368e0);
      }
      .weather-info {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        padding: 12px 15px;
        margin: 10px 0;
        border-radius: 10px;
        font-size: 0.9em;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .weather-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 2px solid #e9ecef;
      }

      .current-weather-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .weather-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .weather-card:hover {
        transform: translateY(-5px);
      }

      .city-name {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .temperature {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
      }

      .condition {
        font-size: 0.9em;
        margin: 5px 0;
        opacity: 0.9;
      }

      .humidity {
        font-size: 0.8em;
        opacity: 0.8;
      }

      .weather-update {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
      }

      .refresh-weather {
        background: linear-gradient(45deg, #00b894, #00cec9);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .refresh-weather:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }

      .last-update {
        font-size: 0.8em;
        color: #666;
      }

      .wind-info {
        font-size: 0.8em;
        opacity: 0.8;
        margin-top: 5px;
      }

      .feels-like {
        font-size: 0.8em;
        opacity: 0.8;
        margin-top: 3px;
      }
      .reset-button-container {
        text-align: center;
        margin-bottom: 15px;
      }

      .reset-button {
        background: linear-gradient(45deg, #ff7675, #fd79a8);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .reset-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      /* Settings Button and Panel Styles */
      .settings-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .settings-button:hover {
        transform: translateY(-3px) scale(1.1);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
      }

      .settings-button.active {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        transform: rotate(180deg);
      }

      .settings-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .settings-panel.active {
        transform: translate(-50%, -50%) scale(1);
      }

      .settings-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .settings-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f2f6;
      }

      .settings-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
      }

      .close-settings {
        background: none;
        border: none;
        font-size: 24px;
        color: #7f8c8d;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-settings:hover {
        background: #f8f9fa;
        color: #e74c3c;
        transform: rotate(90deg);
      }

      .settings-section {
        margin-bottom: 25px;
      }

      .settings-section h3 {
        color: #34495e;
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-group {
        display: grid;
        gap: 12px;
      }

      .toggle-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .toggle-item:hover {
        background: #e9ecef;
        border-color: #ddd;
      }

      .toggle-item.disabled {
        background: #f1f2f6;
        border-color: #e74c3c;
        opacity: 0.7;
      }

      .toggle-label {
        font-weight: 500;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: #bdc3c7;
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .toggle-switch.active {
        background: #27ae60;
      }

      .toggle-switch::before {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .toggle-switch.active::before {
        transform: translateX(24px);
      }

      .settings-footer {
        padding-top: 20px;
        border-top: 2px solid #f1f2f6;
        text-align: center;
      }

      .apply-settings {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      }

      .apply-settings:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
      }

      /* Hide sections when disabled */
      .main-content.hide-itinerary .itinerary-section,
      .main-content.hide-map .map-section {
        display: none;
      }

      .main-content.hide-itinerary {
        grid-template-columns: 1fr;
      }

      .main-content.hide-map {
        grid-template-columns: 1fr;
      }

      #weather-section.hidden,
      #budget-section.hidden {
        display: none;
      }

      /* Dark Mode Styles */
      body.dark-mode {
        background-image: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        color: #e8e8e8;
      }

      body.dark-mode .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #ecf0f1;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      body.dark-mode .header h1 {
        color: #3498db;
      }

      body.dark-mode .info-card {
        background: #34495e;
        color: #ecf0f1;
        border-left-color: #3498db;
      }

      body.dark-mode .itinerary-section,
      body.dark-mode .map-section,
      body.dark-mode .budget-section {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #ecf0f1;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      body.dark-mode .day-card {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        color: #ecf0f1;
        border-color: #3498db;
      }

      body.dark-mode .day-card:hover {
        box-shadow: 0 15px 35px rgba(52, 152, 219, 0.3);
      }

      body.dark-mode .day-card.active {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border-color: #3498db;
      }

      body.dark-mode .day-number {
        background: #3498db;
        color: white;
      }

      body.dark-mode .activity {
        background: rgba(52, 73, 94, 0.8);
        color: #ecf0f1;
      }

      body.dark-mode .route-info {
        background: #34495e;
        color: #ecf0f1;
        border-left-color: #3498db;
      }

      body.dark-mode .special-highlight {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
      }

      body.dark-mode .warning {
        background: #f39c12;
        color: #2c3e50;
        border-color: #e67e22;
      }

      body.dark-mode .weather-summary {
        background: #34495e;
        color: #ecf0f1;
        border-color: #3498db;
      }

      body.dark-mode .weather-card {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        border: 2px solid #3498db;
      }

      body.dark-mode .input-section,
      body.dark-mode .result-section {
        background: #34495e;
        color: #ecf0f1;
        border-color: #3498db;
      }

      body.dark-mode .calc-card {
        background: #2c3e50;
        color: #ecf0f1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      body.dark-mode .calc-card label {
        color: #3498db;
      }

      body.dark-mode .value-display {
        background: #34495e;
        color: #2ecc71;
      }

      body.dark-mode .total-per-person,
      body.dark-mode .total-group {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        border: 2px solid #3498db;
      }

      body.dark-mode .chart-container {
        background: #2c3e50;
        color: #ecf0f1;
        border-color: #3498db;
      }

      body.dark-mode .settings-panel {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #ecf0f1;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      }

      body.dark-mode .settings-title {
        color: #3498db;
      }

      body.dark-mode .close-settings {
        color: #bdc3c7;
      }

      body.dark-mode .close-settings:hover {
        background: #34495e;
        color: #e74c3c;
      }

      body.dark-mode .settings-section h3 {
        color: #3498db;
      }

      body.dark-mode .toggle-item {
        background: #34495e;
        border-color: #3498db;
      }

      body.dark-mode .toggle-item:hover {
        background: #2c3e50;
        border-color: #3498db;
      }

      body.dark-mode .toggle-item.disabled {
        background: #2c3e50;
        border-color: #e74c3c;
      }

      body.dark-mode .toggle-label {
        color: #ecf0f1;
      }

      body.dark-mode .reset-button {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      body.dark-mode .refresh-weather {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
      }

      body.dark-mode .apply-settings {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      }

      /* Dark mode toggle animations */
      body.dark-mode-transition,
      body.dark-mode-transition *,
      body.dark-mode-transition *:before,
      body.dark-mode-transition *:after {
        transition: all 0.3s ease !important;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }

        .trip-info {
          grid-template-columns: 1fr;
        }

        .calculator-container {
          grid-template-columns: 1fr;
        }

        .total-display {
          grid-template-columns: 1fr;
        }

        .settings-button {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }

        .settings-panel {
          width: 95%;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Settings Button -->
    <button class="settings-button" onclick="toggleSettings()">
      <span>⚙️</span>
    </button>

    <!-- Settings Panel -->
    <div class="settings-overlay" onclick="closeSettings()"></div>
    <div class="settings-panel">
      <div class="settings-header">
        <h2 class="settings-title">🎛️ การตั้งค่าหน้าจอ</h2>
        <button class="close-settings" onclick="closeSettings()">×</button>
      </div>

      <div class="settings-section">
        <h3>📱 แสดงหรือซ่อนส่วนต่างๆ</h3>
        <div class="toggle-group">
          <div class="toggle-item">
            <div class="toggle-label">
              <span>🗓️</span>
              <span>รายละเอียดการเดินทาง</span>
            </div>
            <div class="toggle-switch active" data-target="itinerary" onclick="toggleSection(this)"></div>
          </div>

          <div class="toggle-item">
            <div class="toggle-label">
              <span>🗺️</span>
              <span>แผนที่เส้นทาง</span>
            </div>
            <div class="toggle-switch active" data-target="map" onclick="toggleSection(this)"></div>
          </div>

          <div class="toggle-item">
            <div class="toggle-label">
              <span>❄️</span>
              <span>สภาพอากาศ</span>
            </div>
            <div class="toggle-switch active" data-target="weather" onclick="toggleSection(this)"></div>
          </div>

          <div class="toggle-item">
            <div class="toggle-label">
              <span>💰</span>
              <span>เครื่องคำนวณค่าใช้จ่าย</span>
            </div>
            <div class="toggle-switch active" data-target="budget" onclick="toggleSection(this)"></div>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <h3>🎨 ธีมและการแสดงผล</h3>
        <div class="toggle-group">
          <div class="toggle-item">
            <div class="toggle-label">
              <span>🌙</span>
              <span>โหมดกลางคืน</span>
            </div>
            <div class="toggle-switch" data-target="dark-mode" onclick="toggleSection(this)"></div>
          </div>

          <div class="toggle-item">
            <div class="toggle-label">
              <span>📊</span>
              <span>แสดงรายละเอียดขั้นสูง</span>
            </div>
            <div class="toggle-switch" data-target="advanced" onclick="toggleSection(this)"></div>
          </div>
        </div>
      </div>


    </div>

    <div class="container">
      <div class="header">
        <h1>
          <img
            style="height: 30px"
            src="https://w7.pngwing.com/pngs/301/302/png-transparent-japan-torii-idea-sticker-t-shirt-japan-logo-sticker-art.png"
          />
          Japan Road Trip
        </h1>
        <p>การท่องเที่ยวญี่ปุ่น 6 วัน 7 คืน | 6 คน </p>
        <div class="trip-info">
          <div class="info-card">
            <h3>📅 วันเดินทาง</h3>
            <p>4-10 ธันวาคม 2025</p>
          </div>

          <div class="info-card">
            <h3>💰 งบประมาณ</h3>
            <p>30,000-40,000 บาท/คน</p>
          </div>
        </div>
      </div>
      
      <div class="header" id="weather-section">
        <div class="itinerary-section">
          <h2>❄️ สภาพอากาศ ☃️</h2>

          <div class="weather-summary">
            <h3>🌤️ สภาพอากาศปัจจุบัน</h3>
            <div class="current-weather-grid">
              <div class="weather-card" id="tokyo-weather">
                <div class="city-name">🗼 Tokyo</div>
                <div class="temperature">--°C</div>
                <div class="condition">กำลังโหลด...</div>
                <div class="humidity" hidden>ความชื้น: --%</div>
              </div>
              <div class="weather-card" id="osaka-weather">
                <div class="city-name">🏰 Osaka</div>
                <div class="temperature">--°C</div>
                <div class="condition">กำลังโหลด...</div>
                <div class="humidity" hidden>ความชื้น: --%</div>
              </div>
              <div class="weather-card" id="fuji-weather">
                <div class="city-name">🗻 Mt. Fuji</div>
                <div class="temperature">--°C</div>
                <div class="condition">กำลังโหลด...</div>
                <div class="humidity" hidden>ความชื้น: --%</div>
              </div>
            </div>
            <div class="weather-update">
              <button onclick="updateWeatherData()" class="refresh-weather" hidden>
                🔄 อัปเดตสภาพอากาศ
              </button>
              <div class="auto-refresh-info">
                <div class="last-update">
                  อัปเดตล่าสุด: <span id="last-update-time">-</span>
                </div>
                <div class="next-update" hidden>
                  อัปเดตอัตโนมัติถัดไป: <span id="next-update-time">-</span>
                </div>
                <div class="auto-refresh-toggle" hidden>
                  <label>
                    <input
                      type="checkbox"
                      id="auto-refresh-toggle"
                      checked
                      onchange="toggleAutoRefresh()" 
                    />
                    อัปเดตอัตโนมัติทุก 10 นาที
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="main-content" id="main-content">
        <div class="itinerary-section">
          <h2>🗓️ รายละเอียดการเดินทาง</h2>
          <div class="day-card" data-day="1">
            <div class="day-header">
              <div class="day-number">วันที่ 1</div>
              <div class="day-date">4 ธันวาคม - เดินทางกลางคืน</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">✈️</span>
                <span>เดินทางจากไทย → นาริตะ (เที่ยวบินกลางคืน)</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🛬</span>
                <span>เช้า: ถึงสนามบินนาริตะ</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🚗</span>
                <span>รับรถเช่า & เดินทางสู่โตเกียว</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🏨</span>
                <span>เช็คอิน: โรงแรมในชิบูยา</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🍜</span>
                <span>พักผ่อน & ทานอาหารเย็นย่านชิบูยา</span>
              </div>
            </div>
            <div class="route-info">
              📍 เส้นทาง: นาริตะ → ชิบูยา (60 กม. | 1.5 ชม.)
            </div>
          </div>

          <div class="day-card" data-day="2">
            <div class="day-header">
              <div class="day-number">วันที่ 2</div>
              <div class="day-date">5 ธันวาคม - สำรวจโตเกียว</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">🏯</span>
                <span>เช้า: วัดเซ็นโซจิ (อาซากุสะ)</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🗼</span>
                <span>กลางวัน: Tokyo Skytree</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🛍️</span>
                <span>บ่าย: ช็อปปิ้งย่านฮาราจูกุ</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🌃</span>
                <span>เย็น: ชมวิวจากโตเกียวสกายทรี</span>
              </div>
            </div>
            <div class="route-info">
              📍 ชิบูยา → อาซากุสะ → ฮาราจูกุ → กลับโรงแรม
            </div>
          </div>

          <div class="day-card" data-day="3">
            <div class="day-header">
              <div class="day-number">วันที่ 3</div>
              <div class="day-date">6 ธันวาคม - ฟูจิ & บ้านผีสิง</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">🗻</span>
                <span>เช้า: เดินทางสู่ภูเขาฟูจิ</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🏞️</span>
                <span>กลางวัน: ทะเลสาบคาวากุจิโกะ</span>
              </div>
              <div class="activity">
                <span class="activity-icon">👻</span>
                <span>บ่าย: Fuji-Q Highland (บ้านผีสิง)</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🎢</span>
                <span>เย็น: เครื่องเล่นสุดหลอน</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🏨</span>
                <span>พักค้างคืน: โรงแรมใกล้ฟูจิ</span>
              </div>
            </div>
            <div class="special-highlight">
              🎃 บ้านผีสิงแนะนำ: Fuji-Q Highland - Do-Dodonpa & Takabisha
            </div>
            <div class="route-info">📍 โตเกียว → ฟูจิ (120 กม. | 2 ชม.)</div>
          </div>

          <div class="day-card" data-day="4">
            <div class="day-header">
              <div class="day-number">วันที่ 4</div>
              <div class="day-date">7 ธันวาคม - เดินทางสู่โอซาก้า</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">🚗</span>
                <span>เช้า: เดินทางจากฟูจิ → โอซาก้า</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🏰</span>
                <span>บ่าย: ปราสาทโอซาก้า</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🍜</span>
                <span>เย็น: ตลาดโดทงโบริ</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🏨</span>
                <span>เช็คอิน: โรงแรมในโอซาก้า</span>
              </div>
            </div>
            <div class="route-info">📍 ฟูจิ → โอซาก้า (400 กม. | 4.5 ชม.)</div>
          </div>

          <div class="day-card special-day" data-day="5">
            <div class="day-header">
              <div class="day-number">วันที่ 5</div>
              <div class="day-date">8 ธันวาคม - Disney Day! 🏰</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">🏰</span>
                <span>เต็มวัน: Tokyo Disneyland/DisneySea</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🎆</span>
                <span>เย็น: Fireworks Show</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🚗</span>
                <span>กลับโรงแรมดึก</span>
              </div>
            </div>
            <div class="special-highlight">
              ✨ วันพิเศษ Disney! เตรียมตัวให้พร้อมตั้งแต่เช้าตรู่
            </div>
            <div class="route-info">
              📍 โอซาก้า → โตเกียว → Disney (550 กม. | 5.5 ชม.)
            </div>
          </div>

          <div class="day-card special-day" data-day="6">
            <div class="day-header">
              <div class="day-number">วันที่ 6</div>
              <div class="day-date">9 ธันวาคม - Harry Potter Day! ⚡</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">⚡</span>
                <span>เต็มวัน: Universal Studios Japan</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🏰</span>
                <span>Wizarding World of Harry Potter</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🍺</span>
                <span>ดื่ม Butterbeer</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🛍️</span>
                <span>ช็อปของที่ระลึก</span>
              </div>
            </div>
            <div class="special-highlight">
              🧙‍♂️ วันเวทมนตร์! อย่าลืมซื้อ Universal Express Pass
            </div>
            <div class="route-info">
              📍 โตเกียว → โอซาก้า USJ (550 กม. | 5.5 ชม.)
            </div>
          </div>

          <div class="day-card" data-day="7">
            <div class="day-header">
              <div class="day-number">วันที่ 7</div>
              <div class="day-date">10 ธันวาคม - เดินทางกลับ</div>
            </div>
            <div class="activities">
              <div class="activity">
                <span class="activity-icon">🛍️</span>
                <span>เช้า: ช็อปปิ้งนาคาตรงนิส</span>
              </div>
              <div class="activity">
                <span class="activity-icon">🚗</span>
                <span>คืนรถเช่า</span>
              </div>
              <div class="activity">
                <span class="activity-icon">✈️</span>
                <span>เดินทางกลับไทย</span>
              </div>
            </div>
            <div class="route-info">
              📍 โอซาก้า → สนามบินคันไซ (50 กม. | 1 ชม.)
            </div>
          </div>
        </div>

        <div class="map-section">
          <h2>🗺️ แผนที่เส้นทางการเดินทาง</h2>
          <div id="map"></div>
          <div class="warning">
            💡 คลิกวันที่ด้านซ้ายเพื่อดูเส้นทางพร้อมระยะทางและเวลาเดินทาง<br />
            📍 คลิกที่จุดสีขาวบนเส้นทางเพื่อดูรายละเอียดระยะทาง
          </div>
          <>
            <img src="https://i.pinimg.com/736x/53/f0/a3/53f0a37d550159101cc895d002722834.jpg">
          </div>
        </div>
      </div>

      <div class="budget-section" id="budget-section">
        <h2>💰 เครื่องคำนวณค่าใช้จ่าย (แบบ Real-time)</h2>

        <div class="calculator-container">
          <div class="input-section">
            <h3>🔧 ปรับแต่งค่าใช้จ่าย</h3>

            <div class="reset-button-container">
              <button onclick="resetBudget()" class="reset-button">
                🔄 รีเซ็ตค่าเริ่มต้น
              </button>
            </div>

            <div class="calculator-grid">
              <div class="calc-card">
                <label>✈️ ตั๋วเครื่องบิน (บาท/คน)</label>
                <input
                  type="range"
                  id="flight-cost"
                  min="10000"
                  max="30000"
                  value="13000"
                  oninput="updateBudget()"
                />
                <div class="value-display" id="flight-value">17,500 บาท</div>
              </div>

              <div class="calc-card">
                <label>🏨 ที่พัก (บาท/คน/คืน)</label>
                <input
                  type="range"
                  id="hotel-cost"
                  min="1000"
                  max="4000"
                  value="2000"
                  oninput="updateBudget()"
                />
                <div class="value-display" id="hotel-value">
                  2,000 บาท × 6 คืน
                </div>
              </div>

              <div class="calc-card">
                <label>🚗 รถเช่า+น้ำมัน (บาท/วัน ÷ 6 คน)</label>
                <input
                  type="range"
                  id="car-cost"
                  min="2000"
                  max="5000"
                  value="3000"
                  oninput="updateBudget()"
                />
                <div class="value-display" id="car-value">3,000 บาท ÷ 6 คน</div>
              </div>

              <div class="calc-card">
                <label>🎢 บัตรสวนสนุก (บาท/คน)</label>
                <input
                  type="range"
                  id="ticket-cost"
                  min="3000"
                  max="8000"
                  value="5000"
                  oninput="updateBudget()"
                />
                <div class="value-display" id="ticket-value">5,000 บาท</div>
              </div>

              <div class="calc-card">
                <label>🍜 อาหาร (บาท/คน/วัน)</label>
                <input
                  type="range"
                  id="food-cost"
                  min="300"
                  max="2000"
                  value="1000"
                  oninput="updateBudget()"
                />
                <div class="value-display" id="food-value">1,000 บาท × 6 วัน</div>
              </div>

              <div class="calc-card">
                <label>🛍️ ช็อปปิ้ง+อื่นๆ (บาท/คน)</label>
                <input
                  type="range"
                  id="shopping-cost"
                  min="500"
                  max="5000"
                  value="1500"
                  oninput="updateBudget()"
                />
                <div class="value-display" id="shopping-value">1,500 บาท</div>
              </div>
            </div>
          </div>

          <div class="result-section">
            <h3>📊 ผลการคำนวณ</h3>

            <div class="total-display">
              <div class="total-per-person">
                <h4>💰 ต่อคน</h4>
                <div class="big-number" id="total-per-person">32,700 บาท</div>
              </div>

              <div class="total-group">
                <h4>👥 รวม 6 คน</h4>
                <div class="big-number" id="total-group">196,200 บาท</div>
              </div>
            </div>

            <div class="budget-status" id="budget-status">
              <div class="status-good">
                ✅ อยู่ในงบประมาณ 30,000-40,000 บาท/คน
              </div>
            </div>

            <div class="breakdown-chart" id="breakdown-chart">
              <h4>📈 สัดส่วนค่าใช้จ่าย</h4>
              <div class="chart-container">
                <div class="chart-bar">
                  <div class="bar flight-bar" style="width: 53.5%"></div>
                  <span>✈️ ตั๋วเครื่องบิน: 53.5%</span>
                </div>
                <div class="chart-bar">
                  <div class="bar hotel-bar" style="width: 22%"></div>
                  <span>🏨 ที่พัก: 22.0%</span>
                </div>
                <div class="chart-bar">
                  <div class="bar ticket-bar" style="width: 15.3%"></div>
                  <span>🎢 สวนสนุก: 15.3%</span>
                </div>
                <div class="chart-bar">
                  <div class="bar food-bar" style="width: 9.2%"></div>
                  <span>🍜 อาหาร: 9.2%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let autoRefreshInterval = null;
      let nextUpdateTimeout = null;
      
      // Settings state
      let settingsState = {
        itinerary: true,
        map: true,
        weather: true,
        budget: true,
        darkMode: false,
        advanced: false
      };

      // Initialize settings from localStorage
      function initSettings() {
        const saved = localStorage.getItem('japanTripSettings');
        if (saved) {
          settingsState = { ...settingsState, ...JSON.parse(saved) };
        }
        
        // Apply dark mode class immediately if enabled
        if (settingsState.darkMode) {
          document.body.classList.add('dark-mode');
        }
        
        applySettings();
      }

      // Toggle settings panel
      function toggleSettings() {
        const button = document.querySelector('.settings-button');
        const panel = document.querySelector('.settings-panel');
        const overlay = document.querySelector('.settings-overlay');
        
        button.classList.toggle('active');
        panel.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Update toggle switches to match current state
        updateToggleSwitches();
      }

      // Close settings panel
      function closeSettings() {
        const button = document.querySelector('.settings-button');
        const panel = document.querySelector('.settings-panel');
        const overlay = document.querySelector('.settings-overlay');
        
        button.classList.remove('active');
        panel.classList.remove('active');
        overlay.classList.remove('active');
      }

      // Toggle individual section
      function toggleSection(element) {
        const target = element.getAttribute('data-target');
        const isActive = element.classList.contains('active');
        
        // Toggle visual state
        element.classList.toggle('active');
        
        // Update settings state
const stateKey = target.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
settingsState[stateKey] = !isActive;
        
        // Apply changes immediately for preview
        applySectionToggle(target, !isActive);
      }

      // Apply section toggle
      function applySectionToggle(target, enabled) {
        const mainContent = document.getElementById('main-content');
        
        switch(target) {
          case 'itinerary':
            if (enabled) {
              mainContent.classList.remove('hide-itinerary');
            } else {
              mainContent.classList.add('hide-itinerary');
            }
            break;
            
          case 'map':
            if (enabled) {
              mainContent.classList.remove('hide-map');
            } else {
              mainContent.classList.add('hide-map');
            }
            break;
            
          case 'weather':
            const weatherSection = document.getElementById('weather-section');
            if (enabled) {
              weatherSection.classList.remove('hidden');
            } else {
              weatherSection.classList.add('hidden');
            }
            break;
            
          case 'budget':
            const budgetSection = document.getElementById('budget-section');
            if (enabled) {
              budgetSection.classList.remove('hidden');
            } else {
              budgetSection.classList.add('hidden');
            }
            break;
            
          case 'dark-mode':
            // Add transition class for smooth animation
            document.body.classList.add('dark-mode-transition');
            
            if (enabled) {
              document.body.classList.add('dark-mode');
            } else {
              document.body.classList.remove('dark-mode');
            }
            
            // Remove transition class after animation completes
            setTimeout(() => {
              document.body.classList.remove('dark-mode-transition');
            }, 300);
            break;
            
          case 'advanced':
            const advancedElements = document.querySelectorAll('.humidity, .wind-info, .feels-like, .auto-refresh-toggle, .next-update');
            advancedElements.forEach(el => {
              if (enabled) {
                el.removeAttribute('hidden');
              } else {
                el.setAttribute('hidden', '');
              }
            });
            break;
        }
      }

      // Update toggle switches to match current state
      function updateToggleSwitches() {
        Object.keys(settingsState).forEach(key => {
          const targetName = key.replace(/([A-Z])/g, '-$1').toLowerCase();
          const toggle = document.querySelector(`[data-target="${targetName}"]`);
          if (toggle) {
            if (settingsState[key]) {
              toggle.classList.add('active');
            } else {
              toggle.classList.remove('active');
            }
          }
        });
      }

      // Apply all settings
      function applySettings() {
        // Apply each setting
        Object.keys(settingsState).forEach(key => {
          const targetName = key.replace(/([A-Z])/g, '-$1').toLowerCase();
          applySectionToggle(targetName, settingsState[key]);
        });
        
        // Save to localStorage
        localStorage.setItem('japanTripSettings', JSON.stringify(settingsState));
        
        // Close settings panel
        closeSettings();
        
        // Show success message
        showNotification('✅ บันทึกการตั้งค่าเรียบร้อย!');
      }

      // Show notification
      function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #27ae60, #2ecc71);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          box-shadow: 0 8px 25px rgba(0,0,0,0.3);
          z-index: 9999;
          font-weight: bold;
          transform: translateX(100%);
          transition: transform 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      $(document).ready(function () {
        initSettings();
        updateWeatherData();
        startAutoRefresh();
      });

      // Initialize map with English map tiles
      var map = L.map("map").setView([35.6762, 139.6503], 6);

      // Use CartoDB Positron tiles for English labels
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 19,
        }
      ).addTo(map);

      // Define locations
      const locations = {
        narita: [35.772, 140.3929],
        shibuya: [35.6598, 139.7006],
        asakusa: [35.7148, 139.7967],
        skytree: [35.7101, 139.8107],
        harajuku: [35.6702, 139.7026],
        fuji: [35.3606, 138.7274],
        fujiq: [35.4884, 138.7785],
        osaka: [34.6937, 135.5023],
        osakaCastle: [34.6873, 135.5262],
        dotonbori: [34.6685, 135.5018],
        disney: [35.6329, 139.8804],
        usj: [34.6658, 135.432],
        kansai: [34.4347, 135.244],
      };

      // Day routes with distances and travel times
      const dayRoutes = {
        1: {
          route: [locations.narita, locations.shibuya],
          distances: ["60 km"],
          times: ["1.5 hours"],
          segments: ["Narita Airport → Shibuya"],
        },
        2: {
          route: [
            locations.shibuya,
            locations.asakusa,
            locations.skytree,
            locations.harajuku,
            locations.shibuya,
          ],
          distances: ["12 km", "3 km", "8 km", "6 km"],
          times: ["30 min", "10 min", "25 min", "20 min"],
          segments: [
            "Shibuya → Asakusa",
            "Asakusa → Tokyo Skytree",
            "Skytree → Harajuku",
            "Harajuku → Shibuya",
          ],
        },
        3: {
          route: [locations.shibuya, locations.fuji, locations.fujiq],
          distances: ["120 km", "15 km"],
          times: ["2 hours", "30 min"],
          segments: ["Shibuya → Mount Fuji", "Mount Fuji → Fuji-Q Highland"],
        },
        4: {
          route: [
            locations.fujiq,
            locations.osaka,
            locations.osakaCastle,
            locations.dotonbori,
          ],
          distances: ["400 km", "5 km", "2 km"],
          times: ["4.5 hours", "15 min", "10 min"],
          segments: [
            "Fuji-Q → Osaka",
            "Osaka → Osaka Castle",
            "Castle → Dotonbori",
          ],
        },
        5: {
          route: [locations.osaka, locations.disney],
          distances: ["550 km"],
          times: ["5.5 hours"],
          segments: ["Osaka → Tokyo Disney Resort"],
        },
        6: {
          route: [locations.disney, locations.usj],
          distances: ["550 km"],
          times: ["5.5 hours"],
          segments: ["Disney → Universal Studios Japan"],
        },
        7: {
          route: [locations.usj, locations.kansai],
          distances: ["50 km"],
          times: ["1 hour"],
          segments: ["USJ → Kansai Airport"],
        },
      };

      // Day colors
      const dayColors = {
        1: "#3498db",
        2: "#e74c3c",
        3: "#f39c12",
        4: "#2ecc71",
        5: "#9b59b6",
        6: "#1abc9c",
        7: "#34495e",
      };

      let currentPolyline = null;
      let currentMarkers = [];

      function showRoute(day) {
        // Clear existing route
        if (currentPolyline) {
          map.removeLayer(currentPolyline);
        }
        currentMarkers.forEach((marker) => map.removeLayer(marker));
        currentMarkers = [];

        // Show new route
        const routeData = dayRoutes[day];
        const color = dayColors[day];

        if (routeData && routeData.route) {
          const route = routeData.route;

          currentPolyline = L.polyline(route, {
            color: color,
            weight: 4,
            opacity: 0.8,
          }).addTo(map);

          // Add markers with location names
          route.forEach((location, index) => {
            const locationKey = Object.keys(locations).find(
              (key) =>
                locations[key][0] === location[0] &&
                locations[key][1] === location[1]
            );

            const marker = L.circleMarker(location, {
              color: color,
              fillColor: color,
              fillOpacity: 0.7,
              radius: 8,
            }).addTo(map);
            currentMarkers.push(marker);

            if (locationKey && locationNames[locationKey]) {
              marker.bindPopup(
                `<strong>${
                  locationNames[locationKey]
                }</strong><br>Day ${day} - Stop ${index + 1}`
              );
            }
          });

          // Add distance and time labels on route segments
          for (let i = 0; i < route.length - 1; i++) {
            const start = route[i];
            const end = route[i + 1];
            const midPoint = [(start[0] + end[0]) / 2, (start[1] + end[1]) / 2];

            if (
              routeData.distances &&
              routeData.distances[i] &&
              routeData.times &&
              routeData.times[i]
            ) {
              const distanceMarker = L.marker(midPoint, {
                icon: L.divIcon({
                  className: "distance-label",
                  html: `<div style="background: white; padding: 4px 8px; border-radius: 15px; border: 2px solid ${color}; font-size: 11px; font-weight: bold; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                        <div style="color: ${color};">${routeData.distances[i]}</div>
                                        <div style="color: #666; font-size: 9px;">${routeData.times[i]}</div>
                                       </div>`,
                  iconSize: [60, 40],
                  iconAnchor: [30, 20],
                }),
              }).addTo(map);
              currentMarkers.push(distanceMarker);

              if (routeData.segments && routeData.segments[i]) {
                distanceMarker.bindPopup(
                  `<strong>${routeData.segments[i]}</strong><br>Distance: ${routeData.distances[i]}<br>Travel Time: ${routeData.times[i]}`
                );
              }
            }
          }

          // Fit map to route
          map.fitBounds(currentPolyline.getBounds(), { padding: [20, 20] });
        }
      }

      // Add click events to day cards
      document.querySelectorAll(".day-card").forEach((card) => {
        card.addEventListener("click", function () {
          // Remove active class from all cards
          document
            .querySelectorAll(".day-card")
            .forEach((c) => c.classList.remove("active"));

          // Add active class to clicked card
          this.classList.add("active");

          // Show route for this day
          const day = parseInt(this.getAttribute("data-day"));
          showRoute(day);
        });
      });

      // Location names in English
      const locationNames = {
        narita: "Narita Airport",
        shibuya: "Shibuya",
        asakusa: "Asakusa (Sensoji Temple)",
        skytree: "Tokyo Skytree",
        harajuku: "Harajuku",
        fuji: "Mount Fuji",
        fujiq: "Fuji-Q Highland",
        osaka: "Osaka",
        osakaCastle: "Osaka Castle",
        dotonbori: "Dotonbori",
        disney: "Tokyo Disney Resort",
        usj: "Universal Studios Japan",
        kansai: "Kansai Airport",
      };

      // Show all locations on initial load
      Object.entries(locations).forEach(([key, coords]) => {
        L.circleMarker(coords, {
          color: "#34495e",
          fillColor: "#ecf0f1",
          fillOpacity: 0.7,
          radius: 6,
        })
          .addTo(map)
          .bindPopup(locationNames[key]);
      });

      // Budget calculator function with URL parameter storage
      function updateBudget() {
        // Get slider values
        const flightCost = parseInt(
          document.getElementById("flight-cost").value
        );
        const hotelCost = parseInt(document.getElementById("hotel-cost").value);
        const carCost = parseInt(document.getElementById("car-cost").value);
        const ticketCost = parseInt(
          document.getElementById("ticket-cost").value
        );
        const foodCost = parseInt(document.getElementById("food-cost").value);
        const shoppingCost = parseInt(
          document.getElementById("shopping-cost").value
        );

        // Save to URL parameters
        const params = new URLSearchParams();
        params.set("flight", flightCost);
        params.set("hotel", hotelCost);
        params.set("car", carCost);
        params.set("ticket", ticketCost);
        params.set("food", foodCost);
        params.set("shopping", shoppingCost);

        // Update URL without refreshing page
        const newUrl = window.location.pathname + "?" + params.toString();
        window.history.replaceState({}, "", newUrl);

        // Update display values
        document.getElementById("flight-value").textContent =
          flightCost.toLocaleString() + " บาท";
        document.getElementById("hotel-value").textContent =
          hotelCost.toLocaleString() + " บาท × 6 คืน";
        document.getElementById("car-value").textContent =
          carCost.toLocaleString() + " บาท ÷ 6 คน";
        document.getElementById("ticket-value").textContent =
          ticketCost.toLocaleString() + " บาท";
        document.getElementById("food-value").textContent =
          foodCost.toLocaleString() + " บาท × 6 วัน";
        document.getElementById("shopping-value").textContent =
          shoppingCost.toLocaleString() + " บาท";

        // Calculate totals per person
        const hotelTotal = hotelCost * 6; // 6 nights
        const carTotal = (carCost * 6) / 6; // 6 days divided by 6 people
        const foodTotal = foodCost * 6; // 6 days

        const totalPerPerson =
          flightCost +
          hotelTotal +
          carTotal +
          ticketCost +
          foodTotal +
          shoppingCost;
        const totalGroup = totalPerPerson * 6;

        // Update total displays
        document.getElementById("total-per-person").textContent =
          totalPerPerson.toLocaleString() + " บาท";
        document.getElementById("total-group").textContent =
          totalGroup.toLocaleString() + " บาท";

        // Update budget status
        const budgetStatus = document.getElementById("budget-status");
        if (totalPerPerson <= 40000) {
          budgetStatus.innerHTML =
            '<div class="status-good">✅ อยู่ในงบประมาณ 30,000-40,000 บาท/คน</div>';
        } else if (totalPerPerson <= 45000) {
          budgetStatus.innerHTML =
            '<div class="status-warning">⚠️ เกินงบประมาณเล็กน้อย (' +
            totalPerPerson.toLocaleString() +
            " บาท/คน)</div>";
        } else {
          budgetStatus.innerHTML =
            '<div class="status-danger">❌ เกินงบประมาณมาก (' +
            totalPerPerson.toLocaleString() +
            " บาท/คน)</div>";
        }

        // Update chart percentages
        const flightPercent = ((flightCost / totalPerPerson) * 100).toFixed(1);
        const hotelPercent = ((hotelTotal / totalPerPerson) * 100).toFixed(1);
        const carPercent = ((carTotal / totalPerPerson) * 100).toFixed(1);
        const ticketPercent = ((ticketCost / totalPerPerson) * 100).toFixed(1);
        const foodPercent = ((foodTotal / totalPerPerson) * 100).toFixed(1);
        const shoppingPercent = ((shoppingCost / totalPerPerson) * 100).toFixed(
          1
        );

        // Update chart
        const chartContainer = document.querySelector(".chart-container");
        chartContainer.innerHTML = `
                <div class="chart-bar">
                    <div class="bar flight-bar" style="width: ${flightPercent}%"></div>
                    <span>✈️ ตั๋วเครื่องบิน: ${flightPercent}% (${flightCost.toLocaleString()} บาท)</span>
                </div>
                <div class="chart-bar">
                    <div class="bar hotel-bar" style="width: ${hotelPercent}%"></div>
                    <span>🏨 ที่พัก: ${hotelPercent}% (${hotelTotal.toLocaleString()} บาท)</span>
                </div>
                <div class="chart-bar">
                    <div class="bar ticket-bar" style="width: ${ticketPercent}%"></div>
                    <span>🎢 สวนสนุก: ${ticketPercent}% (${ticketCost.toLocaleString()} บาท)</span>
                </div>
                <div class="chart-bar">
                    <div class="bar food-bar" style="width: ${foodPercent}%"></div>
                    <span>🍜 อาหาร: ${foodPercent}% (${foodTotal.toLocaleString()} บาท)</span>
                </div>
                <div class="chart-bar">
                    <div class="bar car-bar" style="width: ${carPercent}%"></div>
                    <span>🚗 รถเช่า: ${carPercent}% (${carTotal.toLocaleString()} บาท)</span>
                </div>
                <div class="chart-bar">
                    <div class="bar shopping-bar" style="width: ${shoppingPercent}%"></div>
                    <span>🛍️ ช็อปปิ้ง: ${shoppingPercent}% (${shoppingCost.toLocaleString()} บาท)</span>
                </div>
            `;
      }

      // Load saved budget data from URL parameters
      function loadBudgetData() {
        const urlParams = new URLSearchParams(window.location.search);

        // Set default values
        const defaultValues = {
          flight: 17500,
          hotel: 1200,
          car: 3000,
          ticket: 5000,
          food: 500,
          shopping: 1500,
        };

        // Get values from URL or use defaults
        const budgetData = {
          flight: parseInt(urlParams.get("flight")) || defaultValues.flight,
          hotel: parseInt(urlParams.get("hotel")) || defaultValues.hotel,
          car: parseInt(urlParams.get("car")) || defaultValues.car,
          ticket: parseInt(urlParams.get("ticket")) || defaultValues.ticket,
          food: parseInt(urlParams.get("food")) || defaultValues.food,
          shopping:
            parseInt(urlParams.get("shopping")) || defaultValues.shopping,
        };

        // Set slider values
        document.getElementById("flight-cost").value = budgetData.flight;
        document.getElementById("hotel-cost").value = budgetData.hotel;
        document.getElementById("car-cost").value = budgetData.car;
        document.getElementById("ticket-cost").value = budgetData.ticket;
        document.getElementById("food-cost").value = budgetData.food;
        document.getElementById("shopping-cost").value = budgetData.shopping;
      }

      // Reset budget to defaults
      function resetBudget() {
        document.getElementById("flight-cost").value = 13000;
        document.getElementById("hotel-cost").value = 2000;
        document.getElementById("car-cost").value = 3000;
        document.getElementById("ticket-cost").value = 5000;
        document.getElementById("food-cost").value = 1000;
        document.getElementById("shopping-cost").value = 1500;

        // Clear URL parameters
        window.history.replaceState({}, "", window.location.pathname);
        updateBudget();
      }

      // Weather functions
      function getWeatherIcon(condition, iconUrl) {
        if (iconUrl && iconUrl.includes("weatherapi.com")) {
          return `<img src="https:${iconUrl}" alt="${condition}" style="width: 32px; height: 32px; vertical-align: middle;">`;
        }

        const iconMap = {
          sunny: "☀️",
          clear: "☀️",
          "partly cloudy": "⛅",
          cloudy: "☁️",
          overcast: "☁️",
          mist: "🌫️",
          fog: "🌫️",
          "light rain": "🌧️",
          "moderate rain": "🌧️",
          "heavy rain": "⛈️",
          "light snow": "🌨️",
          "moderate snow": "❄️",
          "heavy snow": "❄️",
          "thundery outbreaks possible": "⛈️",
          blizzard: "❄️",
        };

        return iconMap[condition.toLowerCase()] || "🌤️";
      }

      function getThaiCondition(condition) {
        const thaiMap = {
          sunny: "แสงแดดจ้า",
          clear: "ฟ้าใส",
          "partly cloudy": "มีเมฆบางส่วน",
          cloudy: "มีเมฆ",
          overcast: "มีเมฆมาก",
          mist: "มีหมอกบาง",
          fog: "มีหมอก",
          "patchy rain possible": "อาจมีฝนเป็นหย่อมๆ",
          "patchy rain nearby": "ฝนตกเป็นหย่อมๆ ในบริเวณใกล้เคียง",
          "light rain": "ฝนเบา",
          "moderate rain": "ฝนปานกลาง",
          "heavy rain": "ฝนหนัก",
          "light snow": "หิมะตกเบา",
          "moderate snow": "หิมะตกปานกลาง",
          "heavy snow": "หิมะตกหนัก",
          "thundery outbreaks possible": "อาจมีฟ้าร้องฟ้าผ่า",
          blizzard: "พายุหิมะ",
        };
        return thaiMap[condition.toLowerCase()] || condition;
      }

      function getSimulatedWeatherData(city) {
        const simulatedData = {
          Tokyo: { temp: 8, condition: "partly cloudy", humidity: 65, wind: 12, windDir: "NW", feelsLike: 6 },
          Osaka: { temp: 10, condition: "cloudy", humidity: 70, wind: 8, windDir: "N", feelsLike: 8 },
          "Mt. Fuji": { temp: -2, condition: "light snow", humidity: 80, wind: 15, windDir: "W", feelsLike: -5 }
        };
        
        const data = simulatedData[city] || simulatedData.Tokyo;
        return {
          temperature: data.temp,
          condition: data.condition,
          humidity: data.humidity,
          windSpeed: data.wind,
          windDirection: data.windDir,
          feelsLike: data.feelsLike,
          icon: null,
          localTime: new Date().toISOString()
        };
      }

      async function fetchWeatherData(city, lat, lon) {
        try {
          const cityNames = {
            Tokyo: "Tokyo",
            Osaka: "Osaka",
            "Mt. Fuji": "Fujikawaguchiko",
          };

          const cityQuery = cityNames[city] || "Tokyo";
          const response = await fetch(
            `https://api.weatherapi.com/v1/current.json?key=5327911f346a4466a9b24115251706&q=${cityQuery}&aqi=no`
          );

          if (!response.ok) {
            throw new Error("Weather API request failed");
          }

          const data = await response.json();
          const current = data.current;
          const location = data.location;

          return {
            temperature: Math.round(current.temp_c),
            condition: current.condition.text.toLowerCase(),
            humidity: current.humidity,
            windSpeed: Math.round(current.wind_kph),
            windDirection: current.wind_dir,
            feelsLike: Math.round(current.feelslike_c),
            icon: current.condition.icon,
            localTime: location.localtime,
          };
        } catch (error) {
          console.log("Weather API error:", error);
          return getSimulatedWeatherData(city);
        }
      }

      async function updateWeatherData() {
        const button = document.querySelector(".refresh-weather");
        if (button) {
          button.textContent = "⏳ กำลังอัปเดต...";
          button.disabled = true;
        }

        const cities = [
          { name: "Tokyo", lat: 35.6762, lon: 139.6503, id: "tokyo-weather" },
          { name: "Osaka", lat: 34.6937, lon: 135.5023, id: "osaka-weather" },
          { name: "Mt. Fuji", lat: 35.3606, lon: 138.7274, id: "fuji-weather" },
        ];

        try {
          for (const city of cities) {
            const weatherData = await fetchWeatherData(
              city.name,
              city.lat,
              city.lon
            );
            const weatherCard = document.getElementById(city.id);

            if (weatherCard) {
              const icon = getWeatherIcon(
                weatherData.condition,
                weatherData.icon
              );
              const thaiCondition = getThaiCondition(weatherData.condition);

              weatherCard.querySelector(
                ".temperature"
              ).textContent = `${weatherData.temperature}°C`;
              weatherCard.querySelector(
                ".condition"
              ).innerHTML = `${icon} ${thaiCondition}`;
              weatherCard.querySelector(
                ".humidity"
              ).textContent = `ความชื้น: ${weatherData.humidity}%`;

              let windElement = weatherCard.querySelector(".wind-info");
              if (!windElement) {
                windElement = document.createElement("div");
                windElement.className = "wind-info";
                weatherCard.appendChild(windElement);
              }
              windElement.textContent = `ลม: ${weatherData.windSpeed} km/h ${weatherData.windDirection}`;

              let feelsLikeElement = weatherCard.querySelector(".feels-like");
              if (!feelsLikeElement) {
                feelsLikeElement = document.createElement("div");
                feelsLikeElement.className = "feels-like";
                weatherCard.appendChild(feelsLikeElement);
              }
              feelsLikeElement.textContent = `รู้สึกเหมือน: ${weatherData.feelsLike}°C`;
            }
          }

          const now = new Date();
          const timeString = now.toLocaleString("th-TH", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });
          document.getElementById("last-update-time").textContent = timeString;
        } catch (error) {
          console.error("Error updating weather:", error);
        } finally {
          if (button) {
            button.textContent = "🔄 อัปเดตสภาพอากาศ";
            button.disabled = false;
          }
        }
      }

      function startAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
        if (nextUpdateTimeout) {
          clearTimeout(nextUpdateTimeout);
        }

        autoRefreshInterval = setInterval(() => {
          console.log("Auto-refreshing weather data...");
          updateWeatherData();
          updateNextRefreshTime();
        }, 10 * 60 * 1000);

        updateNextRefreshTime();
      }

      function updateNextRefreshTime() {
        const nextUpdate = new Date();
        nextUpdate.setMinutes(nextUpdate.getMinutes() + 10);

        const timeString = nextUpdate.toLocaleString("th-TH", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const nextUpdateElement = document.getElementById("next-update-time");
        if (nextUpdateElement) {
          nextUpdateElement.textContent = timeString;
        }
      }

      // Show day 1 route by default
      showRoute(1);
      document.querySelector('[data-day="1"]').classList.add("active");

      // Initialize budget calculator
      loadBudgetData();
      updateBudget();
    </script>
  </body>
</html>
